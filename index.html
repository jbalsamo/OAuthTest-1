<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub OAuth2 Example</title>
  </head>

  <body>
    <div id="app">
      <button id="loginBtnGh" style="display: none;">Login with GitHub</button>
      <button id="loginBtnGoogle" style="display: none;">
        Login with Google
      </button>
      <div id="userInfo" style="display: none;">
        <p>Logged in as: <span id="username"></span></p>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <script>
      const clientId = '6085fb4a43d6e7f91833';
      const googleClientId = '330205518852-pv1i1h5ko3cp215thlmcn4ga1l0skf0v.apps.googleusercontent.com';
      const googlescope = 'https://www.googleapis.com/auth/userinfo.email';
      const redirectUri = 'http://localhost:5500';
      const scope = 'read:user';

      const loginBtnGh = document.getElementById('loginBtnGh');
      const loginBtnGoogle = document.getElementById('loginBtnGoogle');
      const logoutBtn = document.getElementById('logoutBtn');
      const userInfo = document.getElementById('userInfo');
      const usernameSpan = document.getElementById('username');

      function showLoginButton() {
        loginBtnGh.style.display = 'block';
        loginBtnGoogle.style.display = 'block';
        userInfo.style.display = 'none';
      }

      function showUserInfo() {
        loginBtnGh.style.display = 'none';
        loginBtnGoogle.style.display = 'none';
        userInfo.style.display = 'block';
      }

      function loginGithub() {
        const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;
        window.location.href = authUrl;
      }

      function loginGoogle() {
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${googleClientId}&redirect_uri=${redirectUri}&response_type=token&scope=${googlescope}`;
        window.location.href = authUrl;
      }

      function logout() {
        localStorage.removeItem('accessToken');
        showLoginButton();
      }

      async function fetchUserInfoGithub(accessToken) {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            Authorization: `Bearer ${accessToken}`
          }
        });
        const data = await response.json();
        usernameSpan.textContent = data.login;
        showUserInfo();
      }

      async function getUserInfo(accessToken) {
        const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
          headers: {
            Authorization: `Bearer ${accessToken}`
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const userInfo = await response.json();
        return userInfo;
      }

      async function fetchUserInfoGoogle(token) {
        const userInfo = await getUserInfo(token);
        usernameSpan.textContent = userInfo.email;
        showUserInfo();
      }

      async function handleCallback() {
        const code = new URLSearchParams(window.location.search).get('code');
        const token = new URLSearchParams(window.location.search).get('access_token');
        if (code) {
          try {
            const response = await fetch('http://localhost:3000/exchange-token', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ code: code })
            });

            if (response.ok) {
              const data = await response.json();
              const accessToken = data.access_token;
              localStorage.setItem('accessToken', accessToken);
              fetchUserInfoGithub(accessToken);
            } else {
              console.error('Failed to exchange code for access token');
            }
          } catch (error) {
            console.error('An error occurred:', error);
          }
        } else if (token) {
          localStorage.setItem('accessToken', token);
          fetchUserInfoGoogle(token);

        }
        // Remove the code from the URL
        history.replaceState({}, document.title, '/');
      }

      loginBtnGh.addEventListener('click', loginGithub);
      loginBtnGoogle.addEventListener('click', loginGoogle);
      logoutBtn.addEventListener('click', logout);

      // Check if user is already logged in
      const accessToken = localStorage.getItem('accessToken');
      if (accessToken) {
        fetchUserInfoGithub(accessToken);
      } else {
        showLoginButton();
      }

      // Handle OAuth callback
      handleCallback();
    </script>
  </body>
</html>
